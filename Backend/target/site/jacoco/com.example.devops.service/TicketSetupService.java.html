<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="th"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TicketSetupService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">backend</a> &gt; <a href="index.source.html" class="el_package">com.example.devops.service</a> &gt; <span class="el_source">TicketSetupService.java</span></div><h1>TicketSetupService.java</h1><pre class="source lang-java linenums">package com.example.devops.service;

import com.example.devops.dto.TicketSetupRequest;
import com.example.devops.model.*;
import com.example.devops.repo.*;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.math.BigDecimal;
import java.time.Instant;
import java.util.*;
import java.util.stream.Collectors;

/**
 * จัดการผังที่นั่ง (Seat Map) และโซนตั๋วของอีเวนต์
 * ตารางที่เกี่ยวข้อง:
 *   seat_zones(event_id) -&gt; seat_rows(zone_id) -&gt; seats(row_id)
 *   zone_ticket_types(zone_id, ticket_type_id) -&gt; ticket_types(price, min/max_per_order, is_active)
 */
@Service
<span class="nc" id="L22">@RequiredArgsConstructor</span>
public class TicketSetupService {

    private final SeatZonesRepository seatZonesRepo;
    private final SeatRowsRepository seatRowsRepo;
    private final SeatsRepository seatsRepo;
    private final ZoneTicketTypesRepository zoneTicketTypesRepo;
    private final TicketTypesRepository ticketTypesRepo;

    // ------------------------------------------------------------
    // READ: สำหรับ prefill Ticket Detail (ดึง seatRows/seatColumns + โซน + ราคา + Advanced Setting)
    // ------------------------------------------------------------
    @Transactional(readOnly = true)
    public Map&lt;String, Object&gt; getSetup(Long eventId) {
<span class="nc" id="L36">        List&lt;SeatZones&gt; zones = seatZonesRepo.findByEventIdOrderBySortOrderAsc(eventId);</span>
<span class="nc" id="L37">        List&lt;Seats&gt; seats = seatsRepo.findAllSeatsByEventId(eventId);</span>

<span class="nc bnc" id="L39" title="All 8 branches missed.">        if ((zones == null || zones.isEmpty()) &amp;&amp; (seats == null || seats.isEmpty())) {</span>
<span class="nc" id="L40">            return null; // ยังไม่เคยตั้งค่า</span>
        }

<span class="nc" id="L43">        int seatRows = 0;</span>
<span class="nc" id="L44">        int seatColumns = 0;</span>
<span class="nc bnc" id="L45" title="All 4 branches missed.">        if (seats != null &amp;&amp; !seats.isEmpty()) {</span>
<span class="nc" id="L46">            Set&lt;String&gt; rowLabels = seats.stream()</span>
<span class="nc" id="L47">                    .map(Seats::getSeat_label)</span>
<span class="nc" id="L48">                    .filter(Objects::nonNull)</span>
<span class="nc bnc" id="L49" title="All 2 branches missed.">                    .map(lbl -&gt; lbl.isEmpty() ? &quot;&quot; : lbl.substring(0, 1))</span>
<span class="nc bnc" id="L50" title="All 2 branches missed.">                    .filter(s -&gt; !s.isEmpty())</span>
<span class="nc" id="L51">                    .collect(Collectors.toCollection(LinkedHashSet::new));</span>
<span class="nc" id="L52">            seatRows = rowLabels.size();</span>

<span class="nc" id="L54">            seatColumns = seats.stream()</span>
<span class="nc" id="L55">                    .map(Seats::getSeat_number)</span>
<span class="nc" id="L56">                    .filter(Objects::nonNull)</span>
<span class="nc" id="L57">                    .mapToInt(Integer::intValue)</span>
<span class="nc" id="L58">                    .max()</span>
<span class="nc" id="L59">                    .orElse(0);</span>
        }

<span class="nc" id="L62">        List&lt;Map&lt;String, Object&gt;&gt; zoneDtos = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L63" title="All 2 branches missed.">        if (zones != null) {</span>
<span class="nc bnc" id="L64" title="All 2 branches missed.">            for (SeatZones z : zones) {</span>
<span class="nc" id="L65">                Map&lt;String, Object&gt; m = new LinkedHashMap&lt;&gt;();</span>
<span class="nc" id="L66">                m.put(&quot;code&quot;, safe(z.getDescription()));</span>
<span class="nc" id="L67">                m.put(&quot;name&quot;, safe(z.getZone_name()));</span>

<span class="nc" id="L69">                Integer price = null;</span>
                try {
<span class="nc" id="L71">                    BigDecimal p = zoneTicketTypesRepo.findFirstPriceByZoneId(z.getZone_id());</span>
<span class="nc bnc" id="L72" title="All 2 branches missed.">                    if (p != null) price = p.intValue();</span>
<span class="nc" id="L73">                } catch (Throwable ignore) { /* no-op */ }</span>

<span class="nc" id="L75">                m.put(&quot;price&quot;, price);</span>
<span class="nc" id="L76">                zoneDtos.add(m);</span>
<span class="nc" id="L77">            }</span>
        }

        // ----- Advanced Setting prefill จาก ticket_types ตัวแรกของอีเวนต์ -----
<span class="nc" id="L81">        Integer minPer = null, maxPer = null;</span>
<span class="nc" id="L82">        Boolean active = null;</span>
<span class="nc" id="L83">        List&lt;TicketTypes&gt; types = ticketTypesRepo.findByEventId(eventId);</span>
<span class="nc bnc" id="L84" title="All 4 branches missed.">        if (types != null &amp;&amp; !types.isEmpty()) {</span>
<span class="nc" id="L85">            TicketTypes t0 = types.get(0);</span>
<span class="nc" id="L86">            minPer = t0.getMin_per_order();</span>
<span class="nc" id="L87">            maxPer = t0.getMax_per_order();</span>
<span class="nc" id="L88">            active = t0.getIs_active();</span>
        }

<span class="nc" id="L91">        Map&lt;String, Object&gt; out = new LinkedHashMap&lt;&gt;();</span>
<span class="nc" id="L92">        out.put(&quot;seatRows&quot;, seatRows);</span>
<span class="nc" id="L93">        out.put(&quot;seatColumns&quot;, seatColumns);</span>
<span class="nc" id="L94">        out.put(&quot;zones&quot;, zoneDtos);</span>
<span class="nc" id="L95">        out.put(&quot;minPerOrder&quot;, minPer);</span>
<span class="nc" id="L96">        out.put(&quot;maxPerOrder&quot;, maxPer);</span>
<span class="nc" id="L97">        out.put(&quot;active&quot;, active);</span>
<span class="nc" id="L98">        return out;</span>
    }

    // ------------------------------------------------------------
    // UPDATE: ใช้วิธี regenerate ใหม่ทั้งหมด (delegate ไป setup)
    // ------------------------------------------------------------
    @Transactional(rollbackFor = Exception.class)
    public Map&lt;String, Object&gt; update(Long eventId, TicketSetupRequest req) {
<span class="nc" id="L106">        return setup(eventId, req);</span>
    }

    // ------------------------------------------------------------
    // CREATE/REGENERATE: ลบของเก่า → สร้างใหม่ทั้งหมด (โซน/row/seat + ticket_types + mapping)
    // ------------------------------------------------------------
    @Transactional(rollbackFor = Exception.class)
    public Map&lt;String, Object&gt; setup(Long eventId, TicketSetupRequest req) {
<span class="nc" id="L114">        System.out.println(&quot;[TicketSetupService] setup start eventId=&quot; + eventId);</span>

<span class="nc" id="L116">        final Instant now = Instant.now();</span>

        // 1) ลบของเก่าเรียงตาม FK
<span class="nc" id="L119">        seatsRepo.deleteByEventId(eventId);</span>
<span class="nc" id="L120">        seatRowsRepo.deleteByEventId(eventId);</span>
<span class="nc" id="L121">        zoneTicketTypesRepo.deleteByEventId(eventId);   // ลบ mapping ก่อน</span>
<span class="nc" id="L122">        ticketTypesRepo.deleteByEventId(eventId);       // ลบ ticket_types ของอีเวนต์</span>
<span class="nc" id="L123">        seatZonesRepo.deleteByEventId(eventId);         // แล้วค่อยลบโซน</span>

        // 2) ตรวจ input
<span class="nc" id="L126">        final int totalRows = req.getSeatRows();</span>
<span class="nc" id="L127">        final int totalCols = req.getSeatColumns();</span>
<span class="nc bnc" id="L128" title="All 4 branches missed.">        if (totalRows &lt;= 0 || totalCols &lt;= 0) {</span>
<span class="nc" id="L129">            throw new IllegalArgumentException(&quot;seatRows/seatColumns ต้องมากกว่า 0&quot;);</span>
        }

        // ✅ รับค่าจาก Advanced Setting (global) + default
<span class="nc bnc" id="L133" title="All 2 branches missed.">        Integer minPer = req.getMinPerOrder() != null ? req.getMinPerOrder() : 1;</span>
<span class="nc bnc" id="L134" title="All 2 branches missed.">        Integer maxPer = req.getMaxPerOrder() != null ? req.getMaxPerOrder() : 1;</span>
<span class="nc bnc" id="L135" title="All 2 branches missed.">        Boolean active = req.getActive() == null ? Boolean.TRUE : req.getActive();</span>

        // 3) สร้างโซน + ถ้ามีราคา → สร้าง ticket_types และ mapping
<span class="nc" id="L138">        List&lt;SeatZones&gt; zones = new ArrayList&lt;&gt;();</span>

<span class="nc bnc" id="L140" title="All 4 branches missed.">        if (req.getZones() != null &amp;&amp; !req.getZones().isEmpty()) {</span>
<span class="nc bnc" id="L141" title="All 2 branches missed.">            for (TicketSetupRequest.ZoneConfig z : req.getZones()) {</span>
                // seat_zones
<span class="nc" id="L143">                SeatZones zone = new SeatZones();</span>
<span class="nc" id="L144">                zone.setEvent_id(eventId);</span>
<span class="nc" id="L145">                zone.setZone_name(z.getName());</span>
<span class="nc" id="L146">                zone.setDescription(z.getCode());</span>
<span class="nc bnc" id="L147" title="All 2 branches missed.">                zone.setSort_order(z.getRowStart() != null ? z.getRowStart() : 1);</span>
<span class="nc" id="L148">                zone.setIs_active(true);</span>
<span class="nc" id="L149">                zone.setCreated_at(now);</span>
<span class="nc" id="L150">                zone.setUpdated_at(now);</span>
<span class="nc" id="L151">                seatZonesRepo.save(zone);</span>
<span class="nc" id="L152">                zones.add(zone);</span>

                // 3.1 ใช้ ticketTypeId ที่ส่งมาถ้ามี
<span class="nc" id="L155">                Long ticketTypeId = z.getTicketTypeId();</span>

                // 3.2 ถ้า UI ส่ง price มา → สร้าง ticket_types ใหม่
<span class="nc bnc" id="L158" title="All 4 branches missed.">                if (ticketTypeId == null &amp;&amp; z.getPrice() != null) {</span>
<span class="nc" id="L159">                    TicketTypes tt = new TicketTypes();</span>
<span class="nc" id="L160">                    tt.setEvent_id(eventId);</span>
<span class="nc bnc" id="L161" title="All 2 branches missed.">                    tt.setType_name(z.getName() != null ? z.getName()</span>
<span class="nc bnc" id="L162" title="All 2 branches missed.">                            : (z.getCode() != null ? z.getCode() : &quot;GENERAL&quot;));</span>
<span class="nc" id="L163">                    tt.setDescription(&quot;Auto-created from Ticket Setup&quot;);</span>
<span class="nc" id="L164">                    tt.setPrice(BigDecimal.valueOf(z.getPrice()));</span>
<span class="nc" id="L165">                    tt.setQuantity_available(null);</span>
<span class="nc" id="L166">                    tt.setQuantity_sold(0);</span>
<span class="nc" id="L167">                    tt.setSale_start_datetime(null);</span>
<span class="nc" id="L168">                    tt.setSale_end_datetime(null);</span>
<span class="nc" id="L169">                    tt.setIs_active(active);</span>
<span class="nc" id="L170">                    tt.setMin_per_order(minPer);</span>
<span class="nc" id="L171">                    tt.setMax_per_order(maxPer);</span>
<span class="nc" id="L172">                    tt.setCreated_at(now);</span>
<span class="nc" id="L173">                    tt.setUpdated_at(now);</span>
<span class="nc" id="L174">                    ticketTypesRepo.save(tt);</span>
<span class="nc" id="L175">                    ticketTypeId = tt.getTicket_type_id();</span>
                }

                // 3.3 ทำ mapping โซน ↔ ticket_type ถ้ามี id แล้ว
<span class="nc bnc" id="L179" title="All 2 branches missed.">                if (ticketTypeId != null) {</span>
<span class="nc" id="L180">                    ZoneTicketTypesId id = new ZoneTicketTypesId(zone.getZone_id(), ticketTypeId);</span>
<span class="nc" id="L181">                    zoneTicketTypesRepo.save(new ZoneTicketTypes(id));</span>
                }
<span class="nc" id="L183">            }</span>
        } else {
            // โซนเดียว (รองรับรูปแบบเก่า)
<span class="nc" id="L186">            SeatZones zone = new SeatZones();</span>
<span class="nc" id="L187">            zone.setEvent_id(eventId);</span>
<span class="nc bnc" id="L188" title="All 2 branches missed.">            zone.setZone_name(req.getZone() != null ? req.getZone() : &quot;GENERAL&quot;);</span>
<span class="nc" id="L189">            zone.setDescription(&quot;AUTO&quot;);</span>
<span class="nc" id="L190">            zone.setSort_order(1);</span>
<span class="nc" id="L191">            zone.setIs_active(true);</span>
<span class="nc" id="L192">            zone.setCreated_at(now);</span>
<span class="nc" id="L193">            zone.setUpdated_at(now);</span>
<span class="nc" id="L194">            seatZonesRepo.save(zone);</span>
<span class="nc" id="L195">            zones.add(zone);</span>

            // ถ้ามีราคาเดี่ยว ๆ → สร้าง ticket type + mapping
<span class="nc bnc" id="L198" title="All 2 branches missed.">            if (req.getPrice() != null) {</span>
<span class="nc" id="L199">                TicketTypes tt = new TicketTypes();</span>
<span class="nc" id="L200">                tt.setEvent_id(eventId);</span>
<span class="nc" id="L201">                tt.setType_name(zone.getZone_name());</span>
<span class="nc" id="L202">                tt.setDescription(&quot;Auto-created from Ticket Setup (single zone)&quot;);</span>
<span class="nc" id="L203">                tt.setPrice(BigDecimal.valueOf(req.getPrice()));</span>
<span class="nc" id="L204">                tt.setIs_active(active);</span>
<span class="nc" id="L205">                tt.setMin_per_order(minPer);</span>
<span class="nc" id="L206">                tt.setMax_per_order(maxPer);</span>
<span class="nc" id="L207">                tt.setCreated_at(now);</span>
<span class="nc" id="L208">                tt.setUpdated_at(now);</span>
<span class="nc" id="L209">                ticketTypesRepo.save(tt);</span>

<span class="nc" id="L211">                ZoneTicketTypesId id = new ZoneTicketTypesId(zone.getZone_id(), tt.getTicket_type_id());</span>
<span class="nc" id="L212">                zoneTicketTypesRepo.save(new ZoneTicketTypes(id));</span>
            }
        }

        // 4) seat_rows
<span class="nc" id="L217">        Map&lt;String, TicketSetupRequest.ZoneConfig&gt; cfgByName = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L218" title="All 2 branches missed.">        if (req.getZones() != null) {</span>
<span class="nc bnc" id="L219" title="All 2 branches missed.">            for (TicketSetupRequest.ZoneConfig zc : req.getZones()) {</span>
<span class="nc bnc" id="L220" title="All 2 branches missed.">                if (zc.getName() != null) cfgByName.put(zc.getName().toLowerCase(), zc);</span>
<span class="nc" id="L221">            }</span>
        }

<span class="nc" id="L224">        List&lt;SeatRows&gt; allRows = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L225" title="All 2 branches missed.">        for (SeatZones zone : zones) {</span>
<span class="nc" id="L226">            int start = 1, end = totalRows;</span>
<span class="nc bnc" id="L227" title="All 2 branches missed.">            var cfg = cfgByName.get(zone.getZone_name() == null ? &quot;&quot; : zone.getZone_name().toLowerCase());</span>
<span class="nc bnc" id="L228" title="All 2 branches missed.">            if (cfg != null) {</span>
<span class="nc bnc" id="L229" title="All 2 branches missed.">                if (cfg.getRowStart() != null) start = cfg.getRowStart();</span>
<span class="nc bnc" id="L230" title="All 2 branches missed.">                if (cfg.getRowEnd() != null)   end   = cfg.getRowEnd();</span>
            }
<span class="nc" id="L232">            start = Math.max(1, start);</span>
<span class="nc" id="L233">            end   = Math.min(totalRows, end);</span>
<span class="nc bnc" id="L234" title="All 2 branches missed.">            if (start &gt; end) continue;</span>

<span class="nc bnc" id="L236" title="All 2 branches missed.">            for (int i = start; i &lt;= end; i++) {</span>
<span class="nc" id="L237">                SeatRows row = new SeatRows();</span>
<span class="nc" id="L238">                row.setZone_id(zone.getZone_id());</span>
<span class="nc" id="L239">                row.setRow_label(String.valueOf((char) ('A' + (i - 1))));</span>
<span class="nc" id="L240">                row.setSort_order(i);</span>
<span class="nc" id="L241">                row.setCreated_at(now);</span>
<span class="nc" id="L242">                row.setUpdated_at(now);</span>
<span class="nc" id="L243">                seatRowsRepo.save(row);</span>
<span class="nc" id="L244">                allRows.add(row);</span>
            }
<span class="nc" id="L246">        }</span>

        // 5) seats
<span class="nc" id="L249">        int totalSeats = 0;</span>
<span class="nc bnc" id="L250" title="All 2 branches missed.">        for (SeatRows row : allRows) {</span>
<span class="nc bnc" id="L251" title="All 2 branches missed.">            for (int c = 1; c &lt;= totalCols; c++) {</span>
<span class="nc" id="L252">                Seats seat = new Seats();</span>
<span class="nc" id="L253">                seat.setRow_id(row.getRow_id());</span>
<span class="nc" id="L254">                seat.setSeat_number(c);</span>
<span class="nc" id="L255">                seat.setSeat_label(row.getRow_label() + c);</span>
<span class="nc" id="L256">                seat.setIs_active(true);</span>
<span class="nc" id="L257">                seat.setCreated_at(now);</span>
<span class="nc" id="L258">                seat.setUpdated_at(now);</span>
<span class="nc" id="L259">                seatsRepo.save(seat);</span>
<span class="nc" id="L260">                totalSeats++;</span>
            }
<span class="nc" id="L262">        }</span>

<span class="nc" id="L264">        System.out.printf(&quot;[TicketSetupService] DONE zones=%d rows=%d seats=%d%n&quot;,</span>
<span class="nc" id="L265">                zones.size(), allRows.size(), totalSeats);</span>

<span class="nc" id="L267">        return Map.of(</span>
                &quot;status&quot;, &quot;ok&quot;,
                &quot;eventId&quot;, eventId,
<span class="nc" id="L270">                &quot;zones&quot;, zones.size(),</span>
<span class="nc" id="L271">                &quot;rows&quot;, allRows.size(),</span>
<span class="nc" id="L272">                &quot;seats&quot;, totalSeats</span>
        );
    }

    // ------------------------------------------------------------
    // ใช้ในหน้า Seat Map Viewer
    // ------------------------------------------------------------
    @Transactional(readOnly = true)
    public List&lt;Map&lt;String, Object&gt;&gt; getSeatGrid(Long eventId) {
<span class="nc" id="L281">        List&lt;Seats&gt; seats = seatsRepo.findAllSeatsByEventId(eventId);</span>
<span class="nc bnc" id="L282" title="All 4 branches missed.">        if (seats == null || seats.isEmpty()) return List.of();</span>

<span class="nc" id="L284">        Map&lt;String, List&lt;Seats&gt;&gt; grouped = new LinkedHashMap&lt;&gt;();</span>
<span class="nc bnc" id="L285" title="All 2 branches missed.">        for (Seats s : seats) {</span>
<span class="nc bnc" id="L286" title="All 4 branches missed.">            String rowLabel = s.getSeat_label() != null &amp;&amp; !s.getSeat_label().isEmpty()</span>
<span class="nc" id="L287">                    ? s.getSeat_label().substring(0, 1) : &quot;?&quot;;</span>
<span class="nc" id="L288">            grouped.computeIfAbsent(rowLabel, k -&gt; new ArrayList&lt;&gt;()).add(s);</span>
<span class="nc" id="L289">        }</span>

<span class="nc" id="L291">        List&lt;Map&lt;String, Object&gt;&gt; result = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L292" title="All 2 branches missed.">        for (Map.Entry&lt;String, List&lt;Seats&gt;&gt; e : grouped.entrySet()) {</span>
<span class="nc" id="L293">            Map&lt;String, Object&gt; row = new LinkedHashMap&lt;&gt;();</span>
<span class="nc" id="L294">            row.put(&quot;rowLabel&quot;, e.getKey());</span>
<span class="nc" id="L295">            row.put(&quot;seats&quot;, e.getValue().stream()</span>
<span class="nc" id="L296">                    .sorted(Comparator.comparingInt(Seats::getSeat_number))</span>
<span class="nc" id="L297">                    .map(s -&gt; Map.of(</span>
<span class="nc" id="L298">                            &quot;seatNumber&quot;, s.getSeat_number(),</span>
<span class="nc" id="L299">                            &quot;seatLabel&quot;, s.getSeat_label(),</span>
<span class="nc" id="L300">                            &quot;active&quot;, s.getIs_active()</span>
                    ))
<span class="nc" id="L302">                    .toList());</span>
<span class="nc" id="L303">            result.add(row);</span>
<span class="nc" id="L304">        }</span>
<span class="nc" id="L305">        return result;</span>
    }

    // ------------------------------------------------------------
    // ดึงโซนทั้งหมดของ event
    // ------------------------------------------------------------
    @Transactional(readOnly = true)
    public List&lt;SeatZones&gt; getZones(Long eventId) {
<span class="nc" id="L313">        return seatZonesRepo.findByEventIdOrderBySortOrderAsc(eventId);</span>
    }

    // ------------------------------------------------------------
    // helpers
    // ------------------------------------------------------------
    private static String safe(String s) {
<span class="nc bnc" id="L320" title="All 2 branches missed.">        return s == null ? &quot;&quot; : s;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>