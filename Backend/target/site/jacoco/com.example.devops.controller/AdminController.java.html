<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="th"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AdminController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">backend</a> &gt; <a href="index.source.html" class="el_package">com.example.devops.controller</a> &gt; <span class="el_source">AdminController.java</span></div><h1>AdminController.java</h1><pre class="source lang-java linenums">package com.example.devops.controller;

import com.example.devops.dto.EventMapper;
import com.example.devops.dto.EventResponse;
import com.example.devops.model.EventsNam;
import com.example.devops.model.Organizer;
import com.example.devops.model.User;
import com.example.devops.repo.EventsNamRepository;
import com.example.devops.repo.OrganizerRepo;
import com.example.devops.repo.UserRepository;
import jakarta.transaction.Transactional;
import org.springframework.http.*;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.security.core.Authentication;
import org.springframework.web.bind.annotation.*;

import java.time.Duration;
import java.util.*;
import java.util.function.Function;
import java.util.stream.Collectors;

@RestController
@RequestMapping(&quot;/api/admin&quot;)
@PreAuthorize(&quot;hasRole('ADMIN')&quot;)
public class AdminController {

    private final UserRepository userRepo;
    private final OrganizerRepo organizerRepo;
    private final EventsNamRepository eventsRepo;

    public AdminController(UserRepository userRepo,
                           OrganizerRepo organizerRepo,
<span class="fc" id="L33">                           EventsNamRepository eventsRepo) {</span>
<span class="fc" id="L34">        this.userRepo = userRepo;</span>
<span class="fc" id="L35">        this.organizerRepo = organizerRepo;</span>
<span class="fc" id="L36">        this.eventsRepo = eventsRepo;</span>
<span class="fc" id="L37">    }</span>

    /* ============== USERS ============== */

    @GetMapping(&quot;/users&quot;)
    public ResponseEntity&lt;?&gt; getAllUsers() {
<span class="fc" id="L43">        List&lt;User&gt; users = userRepo.findAll();</span>
<span class="fc" id="L44">        var data = users.stream().map(u -&gt; {</span>
<span class="fc" id="L45">            Map&lt;String, Object&gt; m = new HashMap&lt;&gt;();</span>
<span class="fc" id="L46">            m.put(&quot;id&quot;, u.getId());</span>
<span class="fc" id="L47">            m.put(&quot;username&quot;, u.getUsername());</span>
<span class="fc" id="L48">            m.put(&quot;email&quot;, u.getEmail());</span>
<span class="fc" id="L49">            m.put(&quot;role&quot;, u.getRole());</span>
<span class="fc" id="L50">            m.put(&quot;firstName&quot;, u.getFirstName());</span>
<span class="fc" id="L51">            m.put(&quot;lastName&quot;, u.getLastName());</span>
<span class="fc" id="L52">            m.put(&quot;phoneNumber&quot;, u.getPhoneNumber());</span>
<span class="fc" id="L53">            m.put(&quot;idCard&quot;, u.getIdCardPassport());</span>
<span class="fc" id="L54">            return m;</span>
<span class="fc" id="L55">        }).toList();</span>
<span class="fc" id="L56">        return ResponseEntity.ok(Map.of(&quot;users&quot;, data, &quot;total&quot;, data.size()));</span>
    }

    /* ============== ORGANIZERS (ย่อ) ============== */

    @GetMapping(&quot;/organizers&quot;)
    public ResponseEntity&lt;?&gt; getAllOrganizers() {
<span class="fc" id="L63">        List&lt;Organizer&gt; orgs = organizerRepo.findAll();</span>
<span class="fc" id="L64">        var data = orgs.stream().map(o -&gt; Map.of(</span>
<span class="fc" id="L65">                &quot;id&quot;, o.getId(),</span>
<span class="fc" id="L66">                &quot;username&quot;, o.getUsername(),</span>
<span class="fc" id="L67">                &quot;email&quot;, o.getEmail(),</span>
<span class="fc" id="L68">                &quot;firstName&quot;, o.getFirstName(),</span>
<span class="fc" id="L69">                &quot;lastName&quot;, o.getLastName(),</span>
<span class="fc" id="L70">                &quot;companyName&quot;, o.getCompanyName(),</span>
<span class="fc" id="L71">                &quot;verificationStatus&quot;, o.getVerificationStatus()</span>
<span class="fc" id="L72">        )).toList();</span>
<span class="fc" id="L73">        return ResponseEntity.ok(Map.of(&quot;organizers&quot;, data, &quot;total&quot;, data.size()));</span>
    }

    /* ============== EVENTS (Permission List) ============== */

    @GetMapping(&quot;/events&quot;)
    public ResponseEntity&lt;?&gt; listEventsByStatus(
            @RequestParam(name = &quot;status&quot;, required = false, defaultValue = &quot;ALL&quot;) String status
    ) {
<span class="pc bpc" id="L82" title="1 of 2 branches missed.">        String st = status == null ? &quot;ALL&quot; : status.toUpperCase(Locale.ROOT);</span>
        List&lt;EventsNam&gt; list;
<span class="fc bfc" id="L84" title="All 2 branches covered.">        if (&quot;ALL&quot;.equals(st)) {</span>
<span class="fc" id="L85">            list = eventsRepo.findAllByOrderByEventIdDesc();</span>
        } else {
<span class="fc bfc" id="L87" title="All 2 branches covered.">            if (!List.of(&quot;PENDING&quot;, &quot;APPROVED&quot;, &quot;REJECTED&quot;, &quot;PUBLISHED&quot;).contains(st)) {</span>
<span class="fc" id="L88">                return ResponseEntity.badRequest().body(Map.of(&quot;message&quot;, &quot;invalid status&quot;));</span>
            }
<span class="fc" id="L90">            list = eventsRepo.findAllByStatus(st);</span>
        }

        // 1) map entity -&gt; DTO (ใส่ organizerId มาแล้ว)
<span class="fc" id="L94">        List&lt;EventResponse&gt; body = list.stream().map(EventMapper::toDto).toList();</span>

        // 2) เติม organizerName แบบ bulk
<span class="fc" id="L97">        Set&lt;Long&gt; orgIds = body.stream()</span>
<span class="fc" id="L98">                .map(EventResponse::getOrganizerId)</span>
<span class="fc" id="L99">                .filter(Objects::nonNull)</span>
<span class="fc" id="L100">                .collect(Collectors.toSet());</span>

<span class="pc bpc" id="L102" title="1 of 2 branches missed.">        if (!orgIds.isEmpty()) {</span>
<span class="fc" id="L103">            Map&lt;Long, Organizer&gt; orgMap = organizerRepo.findAllById(orgIds).stream()</span>
<span class="fc" id="L104">                    .collect(Collectors.toMap(Organizer::getId, Function.identity()));</span>

<span class="fc bfc" id="L106" title="All 2 branches covered.">            for (EventResponse dto : body) {</span>
<span class="fc" id="L107">                Long oid = dto.getOrganizerId();</span>
<span class="pc bpc" id="L108" title="1 of 2 branches missed.">                if (oid != null) {</span>
<span class="fc" id="L109">                    Organizer o = orgMap.get(oid);</span>
<span class="pc bpc" id="L110" title="1 of 2 branches missed.">                    if (o != null) {</span>
<span class="fc" id="L111">                        String company = ns(o.getCompanyName());</span>
<span class="fc" id="L112">                        String username = ns(o.getUsername());</span>
<span class="pc bpc" id="L113" title="1 of 2 branches missed.">                        dto.setOrganizerName(company.isBlank() ? username : company);</span>
                    }
                }
<span class="fc" id="L116">            }</span>
        }

<span class="fc" id="L119">        return ResponseEntity.ok(body);</span>
    }

    @PostMapping(&quot;/events/{id}/approve&quot;)
    @Transactional
    public ResponseEntity&lt;?&gt; approve(@PathVariable(&quot;id&quot;) Long id,
                                     @RequestBody(required = false) Map&lt;String, Object&gt; body,
                                     Authentication auth) {
<span class="fc" id="L127">        Integer adminId = extractAdminId(auth);</span>
<span class="fc bfc" id="L128" title="All 2 branches covered.">        String review = body == null ? null : Objects.toString(body.getOrDefault(&quot;review&quot;, null), null);</span>
<span class="fc" id="L129">        int n = eventsRepo.approve(id, review, adminId);</span>
<span class="fc bfc" id="L130" title="All 2 branches covered.">        if (n == 0) return ResponseEntity.status(HttpStatus.NOT_FOUND).body(Map.of(&quot;message&quot;,&quot;event not found&quot;));</span>
<span class="fc" id="L131">        return ResponseEntity.ok(Map.of(&quot;message&quot;,&quot;approved&quot;,&quot;eventId&quot;, id));</span>
    }

    @PostMapping(&quot;/events/{id}/reject&quot;)
    @Transactional
    public ResponseEntity&lt;?&gt; reject(@PathVariable(&quot;id&quot;) Long id,
                                    @RequestBody Map&lt;String, Object&gt; body,
                                    Authentication auth) {
<span class="pc bpc" id="L139" title="1 of 2 branches missed.">        String review = body == null ? null : Objects.toString(body.get(&quot;review&quot;), null);</span>
<span class="pc bpc" id="L140" title="1 of 4 branches missed.">        if (review == null || review.isBlank()) {</span>
<span class="fc" id="L141">            return ResponseEntity.badRequest().body(Map.of(&quot;message&quot;,&quot;review is required for rejection&quot;));</span>
        }
<span class="fc" id="L143">        Integer adminId = extractAdminId(auth);</span>
<span class="fc" id="L144">        int n = eventsRepo.reject(id, review, adminId);</span>
<span class="fc bfc" id="L145" title="All 2 branches covered.">        if (n == 0) return ResponseEntity.status(HttpStatus.NOT_FOUND).body(Map.of(&quot;message&quot;,&quot;event not found&quot;));</span>
<span class="fc" id="L146">        return ResponseEntity.ok(Map.of(&quot;message&quot;,&quot;rejected&quot;,&quot;eventId&quot;, id));</span>
    }

    @GetMapping(&quot;/events/{id}/review&quot;)
    public ResponseEntity&lt;?&gt; getReview(@PathVariable(&quot;id&quot;) Long id) {
<span class="fc" id="L151">        return eventsRepo.findById(id)</span>
<span class="fc" id="L152">                .&lt;ResponseEntity&lt;?&gt;&gt;map(e -&gt; {</span>
<span class="fc" id="L153">                    Map&lt;String,Object&gt; m = new HashMap&lt;&gt;();</span>
<span class="fc" id="L154">                    m.put(&quot;eventId&quot;, e.getId());</span>
<span class="fc" id="L155">                    m.put(&quot;status&quot;, e.getStatus());</span>
<span class="fc" id="L156">                    m.put(&quot;review&quot;, e.getReview());</span>
<span class="fc" id="L157">                    m.put(&quot;reviewedAt&quot;, e.getReviewed_at());</span>
<span class="fc" id="L158">                    m.put(&quot;reviewedBy&quot;, e.getReviewed_by());</span>
<span class="fc" id="L159">                    m.put(&quot;organizerId&quot;, e.getOrganizerId());</span>
<span class="pc bpc" id="L160" title="1 of 2 branches missed.">                    if (e.getOrganizerId() != null) {</span>
<span class="fc" id="L161">                        organizerRepo.findById(e.getOrganizerId()).ifPresent(o -&gt; {</span>
<span class="fc" id="L162">                            String company = ns(o.getCompanyName());</span>
<span class="fc" id="L163">                            String username = ns(o.getUsername());</span>
<span class="pc bpc" id="L164" title="1 of 2 branches missed.">                            m.put(&quot;organizerName&quot;, company.isBlank() ? username : company);</span>
<span class="fc" id="L165">                        });</span>
                    }
<span class="fc" id="L167">                    return ResponseEntity.ok(m);</span>
                })
<span class="fc" id="L169">                .orElseGet(() -&gt; ResponseEntity.status(HttpStatus.NOT_FOUND).body(Map.of(&quot;message&quot;,&quot;event not found&quot;)));</span>
    }

    /* ============== COVER IMAGE ============== */

    @GetMapping(&quot;/events/{id}/cover&quot;)
    public ResponseEntity&lt;byte[]&gt; getEventCover(@PathVariable(&quot;id&quot;) Long id) {
<span class="nc" id="L176">        var opt = eventsRepo.findById(id);</span>
<span class="nc bnc" id="L177" title="All 2 branches missed.">        if (opt.isEmpty()) return ResponseEntity.status(HttpStatus.NOT_FOUND).build();</span>
<span class="nc" id="L178">        var e = opt.get();</span>
<span class="nc" id="L179">        byte[] bytes = e.getCover_image();</span>
<span class="nc bnc" id="L180" title="All 4 branches missed.">        if (bytes == null || bytes.length == 0) return ResponseEntity.status(HttpStatus.NOT_FOUND).build();</span>

<span class="nc" id="L182">        HttpHeaders headers = new HttpHeaders();</span>
<span class="nc" id="L183">        headers.setContentType(MediaType.parseMediaType(</span>
<span class="nc bnc" id="L184" title="All 2 branches missed.">                e.getCover_image_type() != null ? e.getCover_image_type() : &quot;image/png&quot;));</span>
<span class="nc" id="L185">        headers.setCacheControl(CacheControl.maxAge(Duration.ofHours(1)).cachePublic());</span>
<span class="nc" id="L186">        return new ResponseEntity&lt;&gt;(bytes, headers, HttpStatus.OK);</span>
    }

    /* ============== UTIL ============== */

    private Integer extractAdminId(Authentication auth) {
        // TODO: map JWT จริง
<span class="fc" id="L193">        return 1;</span>
    }
<span class="pc bpc" id="L195" title="1 of 2 branches missed.">    private static String ns(String s) { return s == null ? &quot;&quot; : s; }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>