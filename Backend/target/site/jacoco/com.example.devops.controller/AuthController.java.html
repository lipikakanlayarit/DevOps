<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="th"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AuthController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">backend</a> &gt; <a href="index.source.html" class="el_package">com.example.devops.controller</a> &gt; <span class="el_source">AuthController.java</span></div><h1>AuthController.java</h1><pre class="source lang-java linenums">package com.example.devops.controller;

import com.example.devops.model.User;
import com.example.devops.model.Organizer;
import com.example.devops.repo.UserRepository;
import com.example.devops.repo.OrganizerRepo;
import com.example.devops.security.JwtTokenUtil;
import com.fasterxml.jackson.annotation.JsonProperty;
import jakarta.validation.Valid;
import jakarta.validation.constraints.Email;
import jakarta.validation.constraints.NotBlank;
import org.springframework.http.ResponseEntity;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.validation.BindingResult;
import org.springframework.web.bind.annotation.*;

import java.util.HashMap;
import java.util.Map;
import java.util.regex.Pattern;

@RestController
@RequestMapping(&quot;/api/auth&quot;)
public class AuthController {

    private final UserRepository userRepo;
    private final OrganizerRepo organizerRepo;
    private final PasswordEncoder passwordEncoder;
    private final JwtTokenUtil jwtUtil;

    // Password validation pattern
<span class="fc" id="L31">    private static final Pattern PASSWORD_PATTERN = Pattern.compile(&quot;^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d).{8,}$&quot;);</span>

    public AuthController(UserRepository userRepo,
                          OrganizerRepo organizerRepo,
                          PasswordEncoder passwordEncoder,
<span class="fc" id="L36">                          JwtTokenUtil jwtUtil) {</span>
<span class="fc" id="L37">        this.userRepo = userRepo;</span>
<span class="fc" id="L38">        this.organizerRepo = organizerRepo;</span>
<span class="fc" id="L39">        this.passwordEncoder = passwordEncoder;</span>
<span class="fc" id="L40">        this.jwtUtil = jwtUtil;</span>
<span class="fc" id="L41">    }</span>

    /* ==================== LOGIN ==================== */
    @PostMapping(&quot;/login&quot;)
    public ResponseEntity&lt;?&gt; login(@Valid @RequestBody LoginRequest req, BindingResult br) {
<span class="fc bfc" id="L46" title="All 2 branches covered.">        if (br.hasErrors()) {</span>
<span class="fc" id="L47">            return ResponseEntity.badRequest().body(Map.of(&quot;error&quot;, &quot;username and password are required&quot;));</span>
        }

<span class="fc" id="L50">        String identifier = trimSafe(req.getUsername());</span>

        // ลองค้นใน User ก่อน
<span class="fc" id="L53">        var userOpt = userRepo.findByUsernameIgnoreCase(identifier);</span>
<span class="fc bfc" id="L54" title="All 2 branches covered.">        if (userOpt.isEmpty()) userOpt = userRepo.findByEmailIgnoreCase(identifier);</span>

<span class="fc bfc" id="L56" title="All 2 branches covered.">        if (userOpt.isPresent()) {</span>
<span class="fc" id="L57">            User user = userOpt.get();</span>
<span class="fc bfc" id="L58" title="All 2 branches covered.">            if (passwordEncoder.matches(req.getPassword(), user.getPassword())) {</span>
<span class="fc" id="L59">                String token = jwtUtil.generateToken(user.getUsername(), user.getRole(), user.getEmail());</span>
<span class="fc" id="L60">                return ResponseEntity.ok(buildAuthResponse(token, user.getId().toString(), user.getUsername(), user.getRole(), user.getEmail()));</span>
            }
        }

        // ถ้าไม่เจอ ลอง Organizer
<span class="fc" id="L65">        var orgOpt = organizerRepo.findByUsernameIgnoreCase(identifier);</span>
<span class="pc bpc" id="L66" title="1 of 2 branches missed.">        if (orgOpt.isEmpty()) orgOpt = organizerRepo.findByEmailIgnoreCase(identifier);</span>

<span class="pc bpc" id="L68" title="1 of 2 branches missed.">        if (orgOpt.isPresent()) {</span>
<span class="nc" id="L69">            Organizer org = orgOpt.get();</span>
<span class="nc bnc" id="L70" title="All 2 branches missed.">            if (passwordEncoder.matches(req.getPassword(), org.getPasswordHash())) {</span>
<span class="nc" id="L71">                String token = jwtUtil.generateToken(org.getUsername(), &quot;ORGANIZER&quot;, org.getEmail());</span>
<span class="nc" id="L72">                return ResponseEntity.ok(buildAuthResponse(token, org.getId().toString(), org.getUsername(), &quot;ORGANIZER&quot;, org.getEmail()));</span>
            }
        }

<span class="fc" id="L76">        return ResponseEntity.status(401).body(Map.of(&quot;error&quot;, &quot;Invalid username/email or password&quot;));</span>
    }

    /* ==================== USER SIGNUP ==================== */
    @PostMapping(&quot;/signup&quot;)
    public ResponseEntity&lt;?&gt; signupUser(@Valid @RequestBody UserSignupRequest req, BindingResult br) {
<span class="nc bnc" id="L82" title="All 2 branches missed.">        if (br.hasErrors()) {</span>
<span class="nc" id="L83">            var errors = br.getFieldErrors().stream()</span>
<span class="nc" id="L84">                    .map(f -&gt; Map.of(&quot;field&quot;, f.getField(), &quot;message&quot;, f.getDefaultMessage()))</span>
<span class="nc" id="L85">                    .toList();</span>
<span class="nc" id="L86">            return ResponseEntity.badRequest().body(Map.of(&quot;error&quot;, &quot;Missing or invalid fields for user signup&quot;, &quot;details&quot;, errors));</span>
        }

        // Validate password strength
<span class="nc bnc" id="L90" title="All 2 branches missed.">        if (!PASSWORD_PATTERN.matcher(req.getPassword()).matches()) {</span>
<span class="nc" id="L91">            return ResponseEntity.badRequest().body(Map.of(</span>
                    &quot;error&quot;, &quot;Password must be at least 8 characters with uppercase, lowercase, and number&quot;
            ));
        }

        try {
<span class="nc" id="L97">            String username = trimSafe(req.getUsername());</span>
<span class="nc" id="L98">            String email = trimSafe(req.getEmail());</span>

            // Check duplicates in User table
<span class="nc bnc" id="L101" title="All 2 branches missed.">            if (userRepo.findByUsernameIgnoreCase(username).isPresent()) {</span>
<span class="nc" id="L102">                return ResponseEntity.badRequest().body(Map.of(&quot;error&quot;, &quot;Username already exists&quot;));</span>
            }
<span class="nc bnc" id="L104" title="All 2 branches missed.">            if (userRepo.findByEmailIgnoreCase(email).isPresent()) {</span>
<span class="nc" id="L105">                return ResponseEntity.badRequest().body(Map.of(&quot;error&quot;, &quot;Email already exists&quot;));</span>
            }

            // Check duplicates in Organizer table
<span class="nc bnc" id="L109" title="All 2 branches missed.">            if (organizerRepo.findByUsernameIgnoreCase(username).isPresent()) {</span>
<span class="nc" id="L110">                return ResponseEntity.badRequest().body(Map.of(&quot;error&quot;, &quot;Username already taken by an organizer&quot;));</span>
            }
<span class="nc bnc" id="L112" title="All 2 branches missed.">            if (organizerRepo.findByEmailIgnoreCase(email).isPresent()) {</span>
<span class="nc" id="L113">                return ResponseEntity.badRequest().body(Map.of(&quot;error&quot;, &quot;Email already taken by an organizer&quot;));</span>
            }

<span class="nc" id="L116">            User user = new User();</span>
<span class="nc" id="L117">            user.setUsername(username);</span>
<span class="nc" id="L118">            user.setEmail(email);</span>
<span class="nc" id="L119">            user.setPassword(passwordEncoder.encode(req.getPassword()));</span>
<span class="nc" id="L120">            user.setRole(&quot;USER&quot;);</span>
<span class="nc" id="L121">            user.setFirstName(trimSafe(req.getFirstName()));</span>
<span class="nc" id="L122">            user.setLastName(trimSafe(req.getLastName()));</span>
<span class="nc" id="L123">            user.setPhoneNumber(trimSafe(req.getPhoneNumber()));</span>
<span class="nc" id="L124">            user.setIdCardPassport(trimSafe(req.getIdCard()));</span>

<span class="nc" id="L126">            userRepo.save(user);</span>
<span class="nc" id="L127">            return ResponseEntity.ok(Map.of(&quot;message&quot;, &quot;User created successfully&quot;));</span>

<span class="nc" id="L129">        } catch (Exception e) {</span>
<span class="nc" id="L130">            return ResponseEntity.status(500).body(Map.of(&quot;error&quot;, &quot;Registration failed: &quot; + e.getMessage()));</span>
        }
    }

    /* ==================== ORGANIZER SIGNUP ==================== */
    @PostMapping(&quot;/organizer/signup&quot;)
    public ResponseEntity&lt;?&gt; signupOrganizer(@Valid @RequestBody OrganizerSignupRequest req, BindingResult br) {
<span class="nc bnc" id="L137" title="All 2 branches missed.">        if (br.hasErrors()) {</span>
<span class="nc" id="L138">            var errors = br.getFieldErrors().stream()</span>
<span class="nc" id="L139">                    .map(f -&gt; Map.of(&quot;field&quot;, f.getField(), &quot;message&quot;, f.getDefaultMessage()))</span>
<span class="nc" id="L140">                    .toList();</span>
<span class="nc" id="L141">            return ResponseEntity.badRequest().body(Map.of(&quot;error&quot;, &quot;Missing or invalid fields for organizer signup&quot;, &quot;details&quot;, errors));</span>
        }

        // Validate password strength
<span class="nc bnc" id="L145" title="All 2 branches missed.">        if (!PASSWORD_PATTERN.matcher(req.getPassword()).matches()) {</span>
<span class="nc" id="L146">            return ResponseEntity.badRequest().body(Map.of(</span>
                    &quot;error&quot;, &quot;Password must be at least 8 characters with uppercase, lowercase, and number&quot;
            ));
        }

        try {
<span class="nc" id="L152">            String username = trimSafe(req.getUsername());</span>
<span class="nc" id="L153">            String email = trimSafe(req.getEmail());</span>

            // Check duplicates in Organizer table
<span class="nc bnc" id="L156" title="All 2 branches missed.">            if (organizerRepo.findByUsernameIgnoreCase(username).isPresent()) {</span>
<span class="nc" id="L157">                return ResponseEntity.badRequest().body(Map.of(&quot;error&quot;, &quot;Username already exists&quot;));</span>
            }
<span class="nc bnc" id="L159" title="All 2 branches missed.">            if (organizerRepo.findByEmailIgnoreCase(email).isPresent()) {</span>
<span class="nc" id="L160">                return ResponseEntity.badRequest().body(Map.of(&quot;error&quot;, &quot;Email already exists&quot;));</span>
            }

            // Check duplicates in User table
<span class="nc bnc" id="L164" title="All 2 branches missed.">            if (userRepo.findByUsernameIgnoreCase(username).isPresent()) {</span>
<span class="nc" id="L165">                return ResponseEntity.badRequest().body(Map.of(&quot;error&quot;, &quot;Username already taken by a user&quot;));</span>
            }
<span class="nc bnc" id="L167" title="All 2 branches missed.">            if (userRepo.findByEmailIgnoreCase(email).isPresent()) {</span>
<span class="nc" id="L168">                return ResponseEntity.badRequest().body(Map.of(&quot;error&quot;, &quot;Email already taken by a user&quot;));</span>
            }

<span class="nc" id="L171">            Organizer org = new Organizer();</span>
<span class="nc" id="L172">            org.setUsername(username);</span>
<span class="nc" id="L173">            org.setEmail(email);</span>
<span class="nc" id="L174">            org.setPasswordHash(passwordEncoder.encode(req.getPassword()));</span>
<span class="nc" id="L175">            org.setFirstName(trimSafe(req.getFirstName()));</span>
<span class="nc" id="L176">            org.setLastName(trimSafe(req.getLastName()));</span>
<span class="nc" id="L177">            org.setPhoneNumber(trimSafe(req.getPhoneNumber()));</span>
<span class="nc" id="L178">            org.setAddress(trimSafe(req.getAddress()));</span>
<span class="nc" id="L179">            org.setCompanyName(trimSafe(req.getCompanyName()));</span>
<span class="nc" id="L180">            org.setTaxId(trimSafe(req.getTaxId()));</span>
<span class="nc" id="L181">            org.setVerificationStatus(&quot;PENDING&quot;);</span>

<span class="nc" id="L183">            organizerRepo.save(org);</span>
<span class="nc" id="L184">            return ResponseEntity.ok(Map.of(&quot;message&quot;, &quot;Organizer created successfully, pending verification&quot;));</span>

<span class="nc" id="L186">        } catch (Exception e) {</span>
<span class="nc" id="L187">            return ResponseEntity.status(500).body(Map.of(&quot;error&quot;, &quot;Registration failed: &quot; + e.getMessage()));</span>
        }
    }

    /* ==================== DTO CLASSES ==================== */

<span class="fc" id="L193">    public static class LoginRequest {</span>
        @NotBlank private String username;
        @NotBlank private String password;
<span class="fc" id="L196">        public String getUsername() { return username; }</span>
<span class="fc" id="L197">        public void setUsername(String username) { this.username = username; }</span>
<span class="fc" id="L198">        public String getPassword() { return password; }</span>
<span class="fc" id="L199">        public void setPassword(String password) { this.password = password; }</span>
    }

<span class="nc" id="L202">    public static class UserSignupRequest {</span>
        @Email @NotBlank private String email;
        @NotBlank private String username;
        @NotBlank private String password;
        @NotBlank private String firstName;
        @NotBlank private String lastName;
        @NotBlank private String phoneNumber;
        @NotBlank private String idCard;

<span class="nc" id="L211">        public String getEmail() { return email; }</span>
<span class="nc" id="L212">        public void setEmail(String email) { this.email = email; }</span>
<span class="nc" id="L213">        public String getUsername() { return username; }</span>
<span class="nc" id="L214">        public void setUsername(String username) { this.username = username; }</span>
<span class="nc" id="L215">        public String getPassword() { return password; }</span>
<span class="nc" id="L216">        public void setPassword(String password) { this.password = password; }</span>
<span class="nc" id="L217">        public String getFirstName() { return firstName; }</span>
<span class="nc" id="L218">        public void setFirstName(String firstName) { this.firstName = firstName; }</span>
<span class="nc" id="L219">        public String getLastName() { return lastName; }</span>
<span class="nc" id="L220">        public void setLastName(String lastName) { this.lastName = lastName; }</span>
<span class="nc" id="L221">        public String getPhoneNumber() { return phoneNumber; }</span>
<span class="nc" id="L222">        public void setPhoneNumber(String phoneNumber) { this.phoneNumber = phoneNumber; }</span>
<span class="nc" id="L223">        public String getIdCard() { return idCard; }</span>
<span class="nc" id="L224">        public void setIdCard(String idCard) { this.idCard = idCard; }</span>
    }

<span class="nc" id="L227">    public static class OrganizerSignupRequest {</span>
        @Email @NotBlank private String email;
        @NotBlank private String username;
        @NotBlank private String password;

        @JsonProperty(&quot;firstName&quot;) @NotBlank private String firstName;
        @JsonProperty(&quot;lastName&quot;) @NotBlank private String lastName;
        @JsonProperty(&quot;phoneNumber&quot;) @NotBlank private String phoneNumber;
        @JsonProperty(&quot;address&quot;) @NotBlank private String address;
        @JsonProperty(&quot;companyName&quot;) @NotBlank private String companyName;
        @JsonProperty(&quot;taxId&quot;) @NotBlank private String taxId;

<span class="nc" id="L239">        public String getEmail() { return email; }</span>
<span class="nc" id="L240">        public void setEmail(String email) { this.email = email; }</span>
<span class="nc" id="L241">        public String getUsername() { return username; }</span>
<span class="nc" id="L242">        public void setUsername(String username) { this.username = username; }</span>
<span class="nc" id="L243">        public String getPassword() { return password; }</span>
<span class="nc" id="L244">        public void setPassword(String password) { this.password = password; }</span>
<span class="nc" id="L245">        public String getFirstName() { return firstName; }</span>
<span class="nc" id="L246">        public void setFirstName(String firstName) { this.firstName = firstName; }</span>
<span class="nc" id="L247">        public String getLastName() { return lastName; }</span>
<span class="nc" id="L248">        public void setLastName(String lastName) { this.lastName = lastName; }</span>
<span class="nc" id="L249">        public String getPhoneNumber() { return phoneNumber; }</span>
<span class="nc" id="L250">        public void setPhoneNumber(String phoneNumber) { this.phoneNumber = phoneNumber; }</span>
<span class="nc" id="L251">        public String getAddress() { return address; }</span>
<span class="nc" id="L252">        public void setAddress(String address) { this.address = address; }</span>
<span class="nc" id="L253">        public String getCompanyName() { return companyName; }</span>
<span class="nc" id="L254">        public void setCompanyName(String companyName) { this.companyName = companyName; }</span>
<span class="nc" id="L255">        public String getTaxId() { return taxId; }</span>
<span class="nc" id="L256">        public void setTaxId(String taxId) { this.taxId = taxId; }</span>
    }

    /* ==================== UTILITIES ==================== */

    private static String trimSafe(String s) {
<span class="pc bpc" id="L262" title="1 of 2 branches missed.">        return s == null ? &quot;&quot; : s.trim();</span>
    }

    private static Map&lt;String, Object&gt; buildAuthResponse(String token, String id, String username, String role, String email) {
<span class="fc" id="L266">        Map&lt;String, Object&gt; response = new HashMap&lt;&gt;();</span>
<span class="fc" id="L267">        response.put(&quot;token&quot;, token);</span>
<span class="fc" id="L268">        Map&lt;String, Object&gt; userData = new HashMap&lt;&gt;();</span>
<span class="fc" id="L269">        userData.put(&quot;id&quot;, id);</span>
<span class="fc" id="L270">        userData.put(&quot;username&quot;, username);</span>
<span class="fc" id="L271">        userData.put(&quot;role&quot;, role);</span>
<span class="fc" id="L272">        userData.put(&quot;email&quot;, email);</span>
<span class="fc" id="L273">        response.put(&quot;user&quot;, userData);</span>
<span class="fc" id="L274">        return response;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>